import gspread
from oauth2client.service_account import ServiceAccountCredentials
from openai import OpenAI
import time
import re

GOOGLE_SHEET_ID = "1U6gW0yqh3GZlkyxvhF_5k3sXMP8GwZT-TNsXqKv7S1o"
CREDENTIALS_FILE = "service-account.json"
SHEET_TAB = "Sheet4"

OPENAI_API_KEY = "PASTE_YOUR_OPENAI_API_KEY_HERE"
TEMPERATURE = 0

client = OpenAI(api_key=OPENAI_API_KEY)

def choose_model(text):
    technical_keywords = [
        "calculate", "find the value", "solve", "integral", "derivative",
        "velocity", "current", "resistance", "probability", "matrix",
        "compound interest", "force", "acceleration"
    ]
    text = text.lower()
    for word in technical_keywords:
        if word in text:
            return "gpt-4.1"
    return "gpt-4o-mini"

def remove_latex(text):
    if not text:
        return text

    text = re.sub(r"\\frac\{([^}]*)\}\{([^}]*)\}", r"\1/\2", text)
    text = re.sub(r"\^\{([^}]*)\}", r"^\1", text)
    text = re.sub(r"_\{([^}]*)\}", r"_\1", text)

    replacements = {
        r"\times": "×",
        r"\cdot": "·",
        r"\pm": "±",
        r"\theta": "θ",
        r"\alpha": "α",
        r"\beta": "β",
        r"\pi": "π"
    }

    for k, v in replacements.items():
        text = text.replace(k, v)

    text = re.sub(r"\\[a-zA-Z]+", "", text)
    text = text.replace("\\(", "").replace("\\)", "")
    text = text.replace("\\[", "").replace("\\]", "")

    return text.strip()

scope = [
    "https://spreadsheets.google.com/feeds",
    "https://www.googleapis.com/auth/drive"
]

creds = ServiceAccountCredentials.from_json_keyfile_name(CREDENTIALS_FILE, scope)
gs_client = gspread.authorize(creds)

sheet = gs_client.open_by_key(GOOGLE_SHEET_ID).worksheet(SHEET_TAB)

data = sheet.get_all_values()
headers = data[0]
rows = data[1:]

def col(name):
    return headers.index(name)

IDX_TYPE     = col("Question Type")
IDX_QTEXT    = col("Question Text")
IDX_OPTA     = col("Option A")
IDX_OPTB     = col("Option B")
IDX_OPTC     = col("Option C")
IDX_OPTD     = col("Option D")
IDX_CORRECT  = col("Correct Option")
IDX_SOLUTION = col("Solution")
IDX_CONF     = col("Confidence")
IDX_PENDING  = col("Pending")

def smart_html_solution(raw_solution):
    raw_solution = remove_latex(raw_solution)

    if "|" in raw_solution and "\n" in raw_solution:
        rows = raw_solution.strip().split("\n")
        html_rows = ""
        for r in rows:
            cols = [c.strip() for c in r.split("|") if c.strip()]
            if cols:
                html_rows += "<tr>" + "".join(f"<td>{c}</td>" for c in cols) + "</tr>"
        return f"<table border='1' cellpadding='6' cellspacing='0' width='100%'>{html_rows}</table>"
    else:
        return raw_solution

def build_solution(qtype, question, optA, optB, optC, optD, answer):
    model = choose_model(question)

    if qtype.lower() == "mcq":
        prompt = f"""
Question:
{question}

Options:
A) {optA}
B) {optB}
C) {optC}
D) {optD}

Correct Answer (already given): {answer}

Return exactly:

Solution: Full explanation (Unicode only)
Confidence: 0 to 100 percent
"""
    else:
        prompt = f"""
Fill in the blank:
{question}

Correct Answer (already given): {answer}

Return exactly:

Solution: Full explanation (Unicode only)
Confidence: 0 to 100 percent
"""

    response = client.chat.completions.create(
        model=model,
        temperature=TEMPERATURE,
        messages=[{"role": "user", "content": prompt}]
    )

    return response.choices[0].message.content.strip()

for i, row in enumerate(rows, start=2):
    if row[IDX_PENDING].strip().lower() != "pending":
        continue

    qtype = row[IDX_TYPE].strip()
    qtext = row[IDX_QTEXT].strip()
    optA  = row[IDX_OPTA].strip()
    optB  = row[IDX_OPTB].strip()
    optC  = row[IDX_OPTC].strip()
    optD  = row[IDX_OPTD].strip()
    answer = row[IDX_CORRECT].strip()

    if not answer:
        continue

    print(f"✅ Explaining row {i}...")

    result = build_solution(qtype, qtext, optA, optB, optC, optD, answer)

    raw_solution = result.split("Solution:")[1].split("Confidence:")[0].strip()
    confidence = remove_latex(result.split("Confidence:")[1].strip())

    solution = smart_html_solution(raw_solution)

    sheet.update_cell(i, IDX_SOLUTION + 1, solution)
    sheet.update_cell(i, IDX_CONF + 1, confidence)
    sheet.update_cell(i, IDX_PENDING + 1, "done")

    time.sleep(1)

print("✅ ALL ANSWERS CONVERTED INTO LATEX-FREE SOLUTIONS")
