import gspread
from oauth2client.service_account import ServiceAccountCredentials
from openai import OpenAI
import time
import re

# =============== CONFIG ===============

GOOGLE_SHEET_ID = "1U6gW0yqh3GZlkyxvhF_5k3sXMP8GwZT-TNsXqKv7S1o"
CREDENTIALS_FILE = "service-account.json"
SHEET_TAB = "Sheet4"

OPENAI_API_KEY = "PASTE_YOUR_OPENAI_API_KEY_HERE"
TEMPERATURE = 0

client = OpenAI(api_key=OPENAI_API_KEY)

# =============== SUB & SUPER =================

SUPERSCRIPTS = str.maketrans("0123456789n", "⁰¹²³⁴⁵⁶⁷⁸⁹ⁿ")
SUBSCRIPTS   = str.maketrans("0123456789n", "₀₁₂₃₄₅₆₇₈₉ₙ")

# =============== MODEL SWITCH =================

def choose_model(text):
    return "gpt-4.1" if any(w in text.lower() for w in ["solve", "calculate", "omega", "zeta", "integral"]) else "gpt-4o-mini"

# =============== LATEX → UNICODE =================

def latex_to_unicode(text):
    if not text:
        return text

    text = re.sub(r"\\frac\{([^}]*)\}\{([^}]*)\}", r"\1/\2", text)

    text = re.sub(r"\^\{([^}]*)\}", lambda m: m.group(1).translate(SUPERSCRIPTS), text)
    text = re.sub(r"_\{([^}]*)\}", lambda m: m.group(1).translate(SUBSCRIPTS), text)

    text = re.sub(r"\^([0-9n])", lambda m: m.group(1).translate(SUPERSCRIPTS), text)
    text = re.sub(r"_([0-9n])", lambda m: m.group(1).translate(SUBSCRIPTS), text)

    greek = {"\\omega": "ω", "\\zeta": "ζ", "\\alpha": "α", "\\beta": "β"}
    for k, v in greek.items():
        text = text.replace(k, v)

    text = re.sub(r"\\[a-zA-Z]+", "", text)
    return text.replace("\\(", "").replace("\\)", "").strip()

# =============== MARKDOWN REMOVER =================

def remove_markdown(text):
    if not text:
        return text

    text = re.sub(r"\*\*(.*?)\*\*", r"\1", text)
    text = re.sub(r"\*(.*?)\*", r"\1", text)
    text = re.sub(r"#+\s*", "", text)
    text = re.sub(r"^\s*[-•]\s*", "", text, flags=re.MULTILINE)
    text = re.sub(r"^\s*\d+\.\s*", "", text, flags=re.MULTILINE)

    return text.strip()

# =============== GOOGLE SHEET =================

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name(CREDENTIALS_FILE, scope)
sheet = gspread.authorize(creds).open_by_key(GOOGLE_SHEET_ID).worksheet(SHEET_TAB)

data = sheet.get_all_values()
headers = data[0]
rows = data[1:]

def col(name): return headers.index(name)

IDX_TYPE     = col("Question Type")
IDX_QTEXT    = col("Question Text")
IDX_OPTA     = col("Option A")
IDX_OPTB     = col("Option B")
IDX_OPTC     = col("Option C")
IDX_OPTD     = col("Option D")
IDX_CORRECT  = col("Correct Option")
IDX_SOLUTION = col("Solution")
IDX_CONF     = col("Confidence")
IDX_PENDING  = col("Pending")

# =============== GPT EXPLAINER =================

def build_solution(question, A, B, C, D, answer):
    model = choose_model(question)

    prompt = f"""
Question: {question}
A) {A}
B) {B}
C) {C}
D) {D}

Correct Answer: {answer}

Give explanation and confidence score (0–100).
No LaTeX. No Markdown.
"""

    res = client.chat.completions.create(
        model=model,
        temperature=TEMPERATURE,
        messages=[{"role": "user", "content": prompt}]
    )
    return res.choices[0].message.content.strip()

# =============== SAFE PARSER =================

def extract_solution_and_confidence(text):
    text = remove_markdown(latex_to_unicode(text))

    sol_match = re.search(r"solution\s*:\s*(.*)", text, re.I | re.S)
    conf_match = re.search(r"confidence\s*:\s*([0-9]{1,3})", text, re.I)

    solution = sol_match.group(1).strip() if sol_match else text
    confidence = conf_match.group(1).strip() if conf_match else "85"

    return solution, confidence

# =============== MAIN LOOP =================

for i, row in enumerate(rows, start=2):

    if row[IDX_PENDING].strip().lower() != "pending":
        continue

    answer = row[IDX_CORRECT].strip()
    if not answer:
        continue

    result = build_solution(
        row[IDX_QTEXT],
        row[IDX_OPTA], row[IDX_OPTB], row[IDX_OPTC], row[IDX_OPTD],
        answer
    )

    solution, confidence = extract_solution_and_confidence(result)

    sheet.update_cell(i, IDX_SOLUTION + 1, solution)
    sheet.update_cell(i, IDX_CONF + 1, confidence)
    sheet.update_cell(i, IDX_PENDING + 1, "done")

    time.sleep(1)

print("✅ ANSWER → SOLUTION MODE COMPLETED (CLEAN, NO MARKDOWN, NO LATEX)")
