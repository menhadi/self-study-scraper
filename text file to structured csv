import re
import csv
import os

input_folder = r"D:\Vector Academy\Contents\PYQ\Gate\Textile Engineering & Fibre Science (TF)\Textile Engineering & Fibre Science (TF)"
output_file = "combined_questions.csv"

# -------------------------------------------------------------------
# UNIVERSAL REGEX PATTERNS
# -------------------------------------------------------------------

# Section headers â€” supports -, â€“, â€”
section_pattern = re.compile(
    r"(?:\*\*)?Q\.?\s*\d+\s*[\-â€“â€”]\s*Q\.?\s*\d+.*?(?:\*\*)?",
    re.IGNORECASE
)

# Question number formats:
# **Q.1**, Q.1, Q1., Q1), **Q.1** Question text...
question_start_pattern = re.compile(
    r"(?:\*\*)?Q\.?\s*(\d+)(?:\*\*)?",
    re.IGNORECASE
)

# Options (A), (B), (C), (D)
option_pattern = re.compile(r"\([A-D]\)")

# -------------------------------------------------------------------
def extract_question_number(text):
    """Extract question number from any pattern."""
    m = question_start_pattern.search(text)
    if m:
        return m.group(1)
    return None

def remove_q_marker(text):
    """Remove Q.1 , **Q.1**, Q1., Q1) etc."""
    return question_start_pattern.sub("", text).strip()

# -------------------------------------------------------------------
all_rows = []

for filename in os.listdir(input_folder):

    if not filename.lower().endswith(".txt"):
        continue

    file_path = os.path.join(input_folder, filename)
    print(f"ðŸ“„ Processing: {filename}")

    # Read file safely
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            text = f.read()
    except UnicodeError:
        with open(file_path, "r", encoding="utf-16") as f:
            text = f.read()

    text = text.replace("\r", "")

    # Identify section boundaries
    section_positions = [(m.start(), m.group(0)) for m in section_pattern.finditer(text)]
    section_positions.append((len(text), ""))

    found_any = False

    # -------------------------------------------------------------------
    # PROCESS SECTIONS
    # -------------------------------------------------------------------
    for i in range(len(section_positions) - 1):

        sec_start, sec_header = section_positions[i]
        sec_end = section_positions[i + 1][0]
        block = text[sec_start:sec_end].strip()

        # Split on any question marker (lookahead)
        question_blocks = re.split(
            r"(?=(?:\*\*)?Q\.?\s*\d+)",
            block
        )

        # -------------------------------------------------------------------
        # PROCESS QUESTION BLOCKS
        # -------------------------------------------------------------------
        for qb in question_blocks:
            qb = qb.strip()
            if not qb:
                continue

            qnum = extract_question_number(qb)
            if not qnum:
                continue

            found_any = True

            # Remove **Q.1** marker
            body = remove_q_marker(qb).strip()

            # Now split by options
            splitted = option_pattern.split(body)
            labels = option_pattern.findall(body)

            question_text = splitted[0].strip()
            options = {"A": "", "B": "", "C": "", "D": ""}

            # Fill options
            for idx, label in enumerate(labels):
                key = label.strip("()")
                if idx + 1 < len(splitted):
                    options[key] = splitted[idx + 1].strip()

            # Add row
            all_rows.append([
                filename,
                sec_header.strip(),
                f"Q.{qnum}",
                question_text,
                options["A"],
                options["B"],
                options["C"],
                options["D"]
            ])

    if not found_any:
        print(f"âš ï¸ No questions found in: {filename}")

# -------------------------------------------------------------------
# SAVE OUTPUT CSV
# -------------------------------------------------------------------
with open(output_file, "w", newline="", encoding="utf-8") as f:
    writer = csv.writer(f)
    writer.writerow([
        "File Name", "Section", "Question No",
        "Question Text", "Option A", "Option B", "Option C", "Option D"
    ])
    writer.writerows(all_rows)

print("\nâœ… Completed!")
print(f"ðŸ“ Saved: {os.path.abspath(output_file)}")
print(f"ðŸ“Œ Total Questions Extracted: {len(all_rows)}")
