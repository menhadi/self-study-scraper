/*********************************
 * GLOBAL CONFIG
 *********************************/
const GOOGLE_SHEET_ID = "1Ur-uRw_LwfA7UchfwfjwIO6ZQsGtD1fJHQLsYoSxbAU";

const SYNC_TABS = [
  "groups",
  "exams"
];

const API_BASE_URL = "https://exampace.com/api";
const API_KEY = "EXAMPACE_SYNC_KEY_2025";

const BATCH_SIZE = 300;
const TIMESTAMP_FORMAT = "yyyy-MM-dd HH:mm:ss";

/*********************************
 * HELPERS
 *********************************/
function getSheet_(tab) {
  const ss = SpreadsheetApp.openById(GOOGLE_SHEET_ID);
  const sheet = ss.getSheetByName(tab);
  if (!sheet) throw new Error(`âŒ Tab "${tab}" not found`);
  return sheet;
}

function norm_(v) {
  return v === null || v === undefined ? "" : v.toString().trim();
}

function now_() {
  return Utilities.formatDate(
    new Date(),
    Session.getScriptTimeZone(),
    TIMESTAMP_FORMAT
  );
}

function getAllowedColumns_(table) {
  const res = UrlFetchApp.fetch(
    `${API_BASE_URL}/schema.php?table=${encodeURIComponent(table)}`,
    { headers: { "X-API-KEY": API_KEY } }
  );
  const json = JSON.parse(res.getContentText());
  if (!json.success) throw new Error(res.getContentText());
  return json.columns.map(c => c.trim());
}

/*********************************
 * ğŸ”¼ PUSH (UPDATE ONLY â€” SAFE)
 *********************************/
function pushOneTab_(tab) {
  const sheet = getSheet_(tab);

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn())
    .getValues()[0]
    .map(norm_);

  const idCol = headers.findIndex(h => h.toLowerCase() === "id");
  const statusCol = headers.findIndex(h => h.toLowerCase() === "syncstatus");

  if (idCol === -1) throw new Error(`âŒ ${tab}: id column missing`);
  if (statusCol === -1) return Logger.log(`âš ï¸ ${tab}: SyncStatus missing`);

  const allowed = getAllowedColumns_(tab);

  const rows = sheet.getLastRow() > 1
    ? sheet.getRange(2, 1, sheet.getLastRow() - 1, headers.length).getValues()
    : [];

  const payload = [];
  const rowNums = [];

  rows.forEach((row, i) => {
    if (norm_(row[statusCol]).toLowerCase() !== "pending") return;

    const idVal = row[idCol];
    if (idVal === "" || idVal === null) {
      Logger.log(`â­ï¸ ${tab}: row ${i + 2} skipped (id blank)`);
      return;
    }

    const obj = { id: Number(idVal) };

    headers.forEach((h, idx) => {
      if (!allowed.includes(h)) return;
      if (["id", "syncstatus", "created_at"].includes(h.toLowerCase())) return;

      let v = row[idx];
      if (v instanceof Date) {
        v = Utilities.formatDate(v, Session.getScriptTimeZone(), TIMESTAMP_FORMAT);
      }
      obj[h] = v === "" ? null : v;
    });

    obj.updated_at = now_();

    payload.push(obj);
    rowNums.push(i + 2);
  });

  if (!payload.length) {
    Logger.log(`âš ï¸ ${tab}: nothing to push`);
    return;
  }

  const res = UrlFetchApp.fetch(`${API_BASE_URL}/push.php`, {
    method: "post",
    contentType: "application/json",
    headers: { "X-API-KEY": API_KEY },
    payload: JSON.stringify({
      table: tab,
      rows: payload.slice(0, BATCH_SIZE)
    })
  });

  const json = JSON.parse(res.getContentText());
  if (!json.success) throw new Error(res.getContentText());

  rowNums.forEach(r =>
    sheet.getRange(r, statusCol + 1).setValue("Synced")
  );

  Logger.log(`âœ… PUSH ${tab}: ${rowNums.length}`);
}

function pushAllTabs() {
  SYNC_TABS.forEach(t => pushOneTab_(t));
}

/*********************************
 * â¬‡ï¸ PULL (FULL + INCREMENTAL)
 *********************************/
function pullOneTab_(tab) {
  const sheet = getSheet_(tab);

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn())
    .getValues()[0]
    .map(norm_);

  const idCol = headers.findIndex(h => h.toLowerCase() === "id");
  const statusCol = headers.findIndex(h => h.toLowerCase() === "syncstatus");

  if (idCol === -1) throw new Error(`âŒ ${tab}: id missing`);

  const props = PropertiesService.getScriptProperties();
  const key = `lastSync_${GOOGLE_SHEET_ID}_${tab}`;
  const lastSync = props.getProperty(key) || "1970-01-01 00:00:00";

  const rows = sheet.getLastRow() > 1
    ? sheet.getRange(2, 1, sheet.getLastRow() - 1, headers.length).getValues()
    : [];

  const idMap = {};
  rows.forEach((r, i) => {
    if (r[idCol] !== "" && r[idCol] !== null) {
      idMap[Number(r[idCol])] = i + 2;
    }
  });

  const res = UrlFetchApp.fetch(`${API_BASE_URL}/pull.php`, {
    method: "post",
    contentType: "application/json",
    headers: { "X-API-KEY": API_KEY },
    payload: JSON.stringify({
      table: tab,
      lastSync,
      existingIds: lastSync === "1970-01-01 00:00:00"
        ? []
        : Object.keys(idMap)
    })
  });

  const json = JSON.parse(res.getContentText());
  if (!json.success) throw new Error(res.getContentText());

  let maxUpdatedAt = lastSync;

  json.rows.forEach(row => {
    const arr = headers.map(h => {
      if (h.toLowerCase() === "id") return row.id ?? "";
      return row[h] ?? "";
    });

    if (statusCol !== -1) arr[statusCol] = "Synced";

    if (row.updated_at && row.updated_at > maxUpdatedAt) {
      maxUpdatedAt = row.updated_at;
    }

    if (idMap[row.id]) {
      sheet.getRange(idMap[row.id], 1, 1, arr.length).setValues([arr]);
    } else {
      sheet.appendRow(arr);
    }
  });

  props.setProperty(key, maxUpdatedAt);
  Logger.log(`âœ… PULL ${tab}: ${json.rows.length}`);
}

function pullAllTabs() {
  SYNC_TABS.forEach(t => pullOneTab_(t));
}

/*********************************
 * ğŸª„ onEdit â†’ mark Pending
 *********************************/
function onEdit(e) {
  if (!e || !e.range) return;

  const sheet = e.range.getSheet();
  if (!SYNC_TABS.includes(sheet.getName())) return;

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn())
    .getValues()[0]
    .map(norm_);

  const statusCol = headers.findIndex(h => h.toLowerCase() === "syncstatus");
  if (statusCol === -1) return;

  if (e.range.getRow() > 1 && e.range.getColumn() !== statusCol + 1) {
    sheet.getRange(e.range.getRow(), statusCol + 1).setValue("Pending");
  }
}

/*********************************
 * â™»ï¸ RESET SYNC (FULL RELOAD)
 *********************************/
function resetAllLastSync() {
  const props = PropertiesService.getScriptProperties();
  SYNC_TABS.forEach(t =>
    props.deleteProperty(`lastSync_${GOOGLE_SHEET_ID}_${t}`)
  );
  Logger.log("ğŸ” lastSync reset");
}
